<!DOCTYPE html>
<html>
<head>
    <title>Human-in-the-Loop Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .question-container {
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .question {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .input-area {
            margin-top: 15px;
        }
        input[type="text"] {
            padding: 8px;
            width: 70%;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0069d9;
        }
        .history {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .history-item {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f1f1f1;
            border-radius: 4px;
        }
        .submitted {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Browser Automation Assistant</h1>
    
    <div id="connection-status" class="status disconnected">
        Disconnected from server
    </div>
    
    <div id="active-questions"></div>
    
    <div class="history">
        <h2>Interaction History</h2>
        <div id="history-container"></div>
    </div>
    
    <script>
        // Connection status element
        const statusElement = document.getElementById('connection-status');
        
        // Questions container
        const questionsContainer = document.getElementById('active-questions');
        
        // History container
        const historyContainer = document.getElementById('history-container');
        
        // Track active requests
        let activeRequests = {};
        
        // Connect to WebSocket server
        let socket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        function connectWebSocket() {
            socket = new WebSocket('ws://localhost:8765');
            
            socket.onopen = () => {
                console.log('Connected to automation server');
                statusElement.textContent = 'Connected to automation server';
                statusElement.className = 'status connected';
                reconnectAttempts = 0;
            };
            
            socket.onmessage = (event) => {
                console.log('Message received:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'input_request') {
                        handleInputRequest(data);
                    }
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };
            
            socket.onclose = (event) => {
                statusElement.textContent = 'Disconnected from server';
                statusElement.className = 'status disconnected';
                
                // Try to reconnect
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const timeout = Math.min(1000 * reconnectAttempts, 5000);
                    statusElement.textContent = `Connection lost. Reconnecting in ${timeout/1000} seconds...`;
                    
                    setTimeout(() => {
                        connectWebSocket();
                    }, timeout);
                } else {
                    statusElement.textContent = 'Failed to reconnect after multiple attempts';
                }
            };
            
            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }
        
        function handleInputRequest(data) {
            const requestId = data.request_id;
            const question = data.question;
            
            // Create question container
            const questionElement = document.createElement('div');
            questionElement.className = 'question-container';
            questionElement.id = `request-${requestId}`;
            
            // Create question text
            const questionText = document.createElement('div');
            questionText.className = 'question';
            questionText.textContent = question;
            questionElement.appendChild(questionText);
            
            // Create input area
            const inputArea = document.createElement('div');
            inputArea.className = 'input-area';
            
            const inputField = document.createElement('input');
            inputField.type = 'text';
            inputField.id = `input-${requestId}`;
            inputField.placeholder = 'Type your answer here...';
            inputField.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    submitAnswer(requestId);
                }
            });
            
            const submitButton = document.createElement('button');
            submitButton.textContent = 'Submit';
            submitButton.onclick = () => submitAnswer(requestId);
            
            inputArea.appendChild(inputField);
            inputArea.appendChild(document.createTextNode(' '));
            inputArea.appendChild(submitButton);
            
            questionElement.appendChild(inputArea);
            
            // Add to active questions container
            questionsContainer.appendChild(questionElement);
            
            // Focus the input field
            inputField.focus();
            
            // Store as active request
            activeRequests[requestId] = {
                question: question,
                timestamp: new Date()
            };
        }
        
        function submitAnswer(requestId) {
            const inputElement = document.getElementById(`input-${requestId}`);
            const answer = inputElement.value.trim();
            
            if (!answer) {
                alert('Please enter an answer before submitting.');
                return;
            }
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                // Send response
                socket.send(JSON.stringify({
                    type: 'input_response',
                    request_id: requestId,
                    value: answer
                }));
                
                // Remove from active questions
                const questionElement = document.getElementById(`request-${requestId}`);
                questionsContainer.removeChild(questionElement);
                
                // Add to history
                addToHistory(requestId, activeRequests[requestId].question, answer);
                
                // Remove from active requests
                delete activeRequests[requestId];
            } else {
                alert('Connection to server lost. Please refresh the page.');
            }
        }
        
        function addToHistory(requestId, question, answer) {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            const questionPart = document.createElement('div');
            questionPart.innerHTML = `<strong>Question:</strong> ${question}`;
            
            const answerPart = document.createElement('div');
            answerPart.innerHTML = `<strong>Answer:</strong> ${answer}`;
            
            const statusPart = document.createElement('div');
            statusPart.className = 'submitted';
            statusPart.textContent = 'âœ“ Submitted';
            
            historyItem.appendChild(questionPart);
            historyItem.appendChild(answerPart);
            historyItem.appendChild(statusPart);
            
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);
        }
        
        // Connect when page loads
        window.addEventListener('load', () => {
            connectWebSocket();
        });
    </script>
</body>
</html>